<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Storyteller</title>
    <!-- External libraries are kept in the head to be loaded early -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1/build/d3.layout.cloud.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="app-header">
        <h1>Reddit Storyteller</h1>
        <div class="header-controls">
            <div class="theme-switcher">
                <label for="theme-select">Theme:</label>
                <select id="theme-select" class="dropdown-input" aria-label="Select color theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="sepia">Sepia</option>
                </select>
            </div>
            <div class="filter-switch">
                 <label for="nsfw-toggle">Blur NSFW:</label>
                <label class="switch">
                    <input type="checkbox" id="nsfw-toggle" aria-label="Toggle NSFW content blurring">
                    <span class="slider round"></span>
                </label>
            </div>
             <div class="filter-switch">
                 <label for="collapse-comments-toggle">Collapse Comments:</label>
                <label class="switch">
                    <input type="checkbox" id="collapse-comments-toggle" aria-label="Toggle collapsing comments by default">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="layout-controls">
                <button id="layout-toggle-button" class="icon-button" title="Toggle List/Grid View" aria-label="Toggle list or grid view">
                    <svg id="layout-icon-grid" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    <svg id="layout-icon-list" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                </button>
                 <button id="gallery-toggle-button" class="icon-button" title="Toggle Gallery View" style="display: none;" aria-label="Toggle gallery view">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </button>
            </div>
        </div>
    </header>
    
    <main class="main-content">
        <section id="controls-container" class="controls-container">
            <div class="controls">
                <div class="input-group main-input">
                    <label for="subreddit-input">Subreddit (use + for multi):</label>
                    <input type="text" id="subreddit-input" list="subreddit-list" value="AskReddit" class="text-input" aria-label="Subreddit input">
                    <datalist id="subreddit-list"></datalist>
                </div>
                <div class="input-group main-input search-container">
                    <label for="search-input">Search within Subreddit:</label>
                    <input type="text" id="search-input" class="text-input" placeholder="Enter keywords..." aria-label="Search within subreddit">
                    <button id="clear-search-button" class="clear-search-btn" style="display: none;" aria-label="Clear search input">&times;</button>
                </div>
                <button id="fetch-button" class="action-button">Get Stories</button>
                <button id="toggle-filters-button" class="action-button secondary icon-button" title="Toggle Filters" aria-label="Toggle advanced filters">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46V19l4 2v-8.54L22 3z"></polygon></svg>
                </button>
            </div>
            <div id="advanced-filters" class="advanced-filters">
                <div class="input-group">
                    <label for="sort-select">Sort by:</label>
                    <select id="sort-select" class="dropdown-input" aria-label="Sort stories by">
                        <option value="hot">Hot</option>
                        <option value="new">New</option>
                        <option value="top">Top</option>
                        <option value="rising">Rising</option>
                    </select>
                </div>
                 <div class="input-group" id="time-range-controls" style="display: none;">
                    <label for="time-range-select">Time Range:</label>
                    <select id="time-range-select" class="dropdown-input" aria-label="Select time range for top stories">
                        <option value="all">All Time</option>
                        <option value="year">Past Year</option>
                        <option value="month">Past Month</option>
                        <option value="week">Past Week</option>
                        <option value="day">Past 24 Hours</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="flair-filter-input">Filter by Flair:</label>
                    <input type="text" id="flair-filter-input" class="text-input" placeholder="e.g., 'Update', 'Series'" aria-label="Filter stories by flair">
                </div>
                <div class="input-group">
                    <label for="min-score-input">Min Score:</label>
                    <input type="number" id="min-score-input" class="text-input" placeholder="e.g., 1000" aria-label="Filter stories by minimum score">
                </div>
                <div class="input-group">
                    <label for="min-comments-input">Min Comments:</label>
                    <input type="number" id="min-comments-input" class="text-input" placeholder="e.g., 50" aria-label="Filter stories by minimum comments">
                </div>
                <button id="random-button" class="action-button secondary">Random Subreddit</button>
                <button id="surprise-button" class="action-button secondary surprise">Surprise Me!</button>
            </div>
        </section>

        <nav class="action-bar">
            <button id="mark-all-read-button" class="action-button secondary" style="display: none;">Mark Visible as Read</button>
            <button id="view-saved-button" class="action-button secondary">Saved Stories</button>
            <button id="view-history-button" class="action-button secondary">History</button>
        </nav>
        
        <section id="saved-stories-view" class="dedicated-view" style="display: none;">
            <div class="view-header">
                <h3>Saved Stories</h3>
                <div id="saved-sort-section">
                    <div class="sort-search-controls">
                        <div class="input-group">
                            <label for="saved-sort-select">Sort by:</label>
                            <select id="saved-sort-select" class="dropdown-input" aria-label="Sort saved stories by">
                                <option value="date-desc">Date Saved (Newest)</option>
                                <option value="date-asc">Date Saved (Oldest)</option>
                                <option value="score-desc">Score</option>
                                <option value="subreddit-az">Subreddit (A-Z)</option>
                            </select>
                        </div>
                        <div class="input-group search-container">
                            <label for="saved-search-input" class="visually-hidden">Search Saved Stories</label>
                            <input type="text" id="saved-search-input" class="text-input" placeholder="Search saved stories..." aria-label="Search within saved stories">
                        </div>
                    </div>
                </div>
                <div id="saved-tags-filter" class="saved-tags-filter">
                    <h4>Filter by Tag:</h4>
                    <div id="tags-container"></div>
                </div>
            </div>
            <div id="clear-saved-container" class="view-actions">
                <div>
                    <button id="export-saved-button" class="action-button secondary">Export</button>
                    <button id="import-saved-button" class="action-button secondary">Import</button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;" aria-label="Import saved stories file">
                </div>
                <button id="clear-saved-button" class="action-button danger">Clear All Saved</button>
            </div>
        </section>

        <section id="history-view" class="dedicated-view" style="display: none;">
            <div class="view-header">
                 <h3>Reading History</h3>
                <div id="history-sort-section">
                    <div class="sort-search-controls">
                        <div class="input-group">
                            <label for="history-sort-select">Sort by:</label>
                            <select id="history-sort-select" class="dropdown-input" aria-label="Sort history by">
                                <option value="date-desc">Date Read (Newest)</option>
                                <option value="date-asc">Date Read (Oldest)</option>
                                <option value="score-desc">Score</option>
                                <option value="subreddit-az">Subreddit (A-Z)</option>
                            </select>
                        </div>
                        <div class="input-group search-container">
                            <label for="history-search-input" class="visually-hidden">Search History</label>
                            <input type="text" id="history-search-input" class="text-input" placeholder="Search history..." aria-label="Search within history">
                        </div>
                    </div>
                </div>
            </div>
             <div id="clear-history-container" class="view-actions">
                <button id="clear-history-button" class="action-button danger">Clear History</button>
            </div>
        </section>


        <section id="subreddit-info-panel" class="subreddit-info"></section>

        <h2 id="stories-heading" class="stories-heading"></h2>

        <section id="story-container" class="story-container"></section>

        <div id="loading-indicator" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <span>Loading stories...</span>
        </div>
        
        <div id="infinite-scroll-loader" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <span>Loading more stories...</span>
        </div>
    </main>
    
    <!-- Story Reader Popup -->
    <div id="popup-overlay" class="popup-overlay" role="dialog" aria-modal="true" aria-labelledby="popup-title">
        <div class="popup-content">
            <div id="reading-progress-bar" class="reading-progress-bar"></div>
            <header class="popup-header">
                <div class="popup-title-container">
                    <h2 id="popup-title" class="popup-title"></h2>
                    <div id="popup-subreddit-link" class="popup-subreddit-link"></div>
                </div>
                 <div class="popup-header-actions"></div>
                <button id="close-popup" class="close-button" title="Close" aria-label="Close story viewer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </header>
            <nav id="jump-to-nav" class="jump-to-nav"></nav>
            <div class="popup-controls"></div>
            <nav id="comment-navigator" class="comment-navigator" style="display: none;"></nav>
            <nav id="series-navigation" class="series-navigation"></nav>
            <div id="popup-body" class="popup-body"></div>
            <section id="saved-story-tags-container" class="saved-story-tags-container" style="display: none;">
                <h4>Tags</h4>
                <div id="story-tags" class="story-tags"></div>
                <input type="text" id="add-tag-input" placeholder="Add a tag and press Enter..." aria-label="Add a tag to this story">
            </section>
            <section id="saved-story-notes-container" class="saved-story-notes-container" style="display: none;">
                <h4>My Notes</h4>
                <textarea id="saved-story-notes" placeholder="Add personal notes for this story..." aria-label="My notes for this story"></textarea>
            </section>
        </div>
        <button id="gallery-prev" class="gallery-nav prev" style="display: none;" aria-label="Previous image">&#10094;</button>
        <button id="gallery-next" class="gallery-nav next" style="display: none;" aria-label="Next image">&#10095;</button>
    </div>

    <!-- User Profile Popup -->
    <div id="user-profile-overlay" class="popup-overlay" role="dialog" aria-modal="true" aria-labelledby="user-profile-title">
         <div class="popup-content">
             <header class="popup-header">
                <div class="popup-title-container">
                    <h2 id="user-profile-title" class="popup-title"></h2>
                </div>
                <button id="close-user-profile-popup" class="close-button" title="Close" aria-label="Close user profile">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </header>
            <div id="user-profile-body" class="popup-body"></div>
         </div>
    </div>

    <!-- Word Cloud Popup -->
    <div id="word-cloud-overlay" class="popup-overlay" role="dialog" aria-modal="true" aria-labelledby="word-cloud-title">
         <div class="popup-content">
             <header class="popup-header">
                <div class="popup-title-container">
                    <h2 id="word-cloud-title" class="popup-title">Comment Word Cloud</h2>
                </div>
                <button id="close-word-cloud-popup" class="close-button" title="Close" aria-label="Close word cloud viewer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </header>
            <div id="word-cloud-body" class="popup-body">
                <div id="word-cloud-container"></div>
                <p class="word-cloud-info">A visual representation of the most common words in the comments.</p>
            </div>
         </div>
    </div>

    <!-- API Key Popup -->
    <div id="api-key-overlay" class="popup-overlay" role="dialog" aria-modal="true" aria-labelledby="api-key-title">
        <div class="popup-content">
            <header class="popup-header">
                <div class="popup-title-container">
                    <h2 id="api-key-title" class="popup-title">Enter Google AI API Key</h2>
                </div>
                <button id="close-api-key-popup" class="close-button" title="Close" aria-label="Close API Key modal">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </header>
            <div id="api-key-body" class="popup-body">
                <p>To use the AI-powered features (Summarize, Narrate, Translate), you need a Google AI API key.</p>
                <p>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Click here to get your API key from Google AI Studio</a>, then paste it below.
                </p>
                <p class="api-key-note">Your key is saved only in your browser's local storage and is never sent to our servers.</p>
                <div class="input-group">
                    <label for="api-key-input">Your API Key:</label>
                    <input type="password" id="api-key-input" class="text-input" placeholder="Paste your API key here">
                </div>
                <button id="save-api-key-button" class="action-button">Save and Continue</button>
            </div>
        </div>
    </div>
    
    <button id="back-to-top" class="back-to-top" title="Go to top" aria-label="Back to top">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
    </button>
    <div id="toast-notification" role="alert" aria-live="assertive"></div>
    <div id="quick-look-popup"></div>
    <script src="script.js"></script>
</body>
</html>
